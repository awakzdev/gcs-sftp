apiVersion: v1
items:
- apiVersion: batch/v1
  kind: CronJob
  metadata:
    name: sftp-bucket-sync
  spec:
    concurrencyPolicy: Allow
    failedJobsHistoryLimit: 1
    jobTemplate:
      metadata:
        creationTimestamp: null
      spec:
        template:
          metadata:
            creationTimestamp: null
          spec:
            containers:
            - command:
              - /bin/bash
              - -c
              - |
                POD_NAME=$(kubectl get pods --namespace {{ .Release.Namespace }} --no-headers -o custom-columns=":metadata.name" | grep '^{{ .Chart.Name }}-' | head -n 1)
                kubectl exec $POD_NAME --namespace {{ .Release.Namespace }} -- /bin/bash -c '

                  # Authenticate && Synchronize GCS files
                  gcloud auth activate-service-account --key-file /etc/gcp/*.json
                  gsutil -m rsync -r gs://{{ .Values.sftp.bucketName }} /home/*/
                '
              image: google/cloud-sdk:latest
              imagePullPolicy: Always
              name: sftp-bucket-sync
              resources: {}
              terminationMessagePath: /dev/termination-log
              terminationMessagePolicy: File
            dnsPolicy: ClusterFirst
            restartPolicy: OnFailure
            schedulerName: default-scheduler
            securityContext: {}
            terminationGracePeriodSeconds: 30
    schedule: {{ .Values.sftp.schedule }}
    successfulJobsHistoryLimit: 3
    suspend: false
  status: {}
kind: List
metadata:
  resourceVersion: ""